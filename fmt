<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FM Transceiver | Denys Shlyakhtovskyy</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css">

  <style>
    .schematics-list{
      text-align: center;
      margin-top: 8px;
    }
    .schematics-list .section-link{
      display: block;
      width: 100%;
      margin: 14px 0 8px 0;
    }
    .schematics-list .drop-panel{
      text-align: center;
      margin: 0 auto 8px auto;
      max-width: 70ch;
    }
    .schematics-list .drop-panel img{
      margin: 0 auto;
    }
    .schematics-list .drop-panel p{
      text-align: center;
      margin-top: 10px;
    }

    /* stack the two top-level headers vertically */
    #schematicsLink,
    #softwareLink{
      display: block;
      width: fit-content;
      margin: 14px 0 8px 0;
    }

    /* ===== subsystem map ===== */
    .map-wrap{
      position: relative;
      width: 100%;
      max-width: 900px;
      margin: 18px auto 10px;
    }
    .map-wrap img{
      width: 100%;
      height: auto;
      display: block;
      border-radius: 10px;
    }
    .map-overlay{
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
    }

    /* clickable regions: invisible until hover */
    .hot{
      fill: rgba(0,0,0,0);
      stroke: rgba(0,0,0,0);
      stroke-width: 3;
      cursor: pointer;
      transition: fill 180ms ease, stroke 180ms ease;
    }
    .hot:hover{ stroke: rgba(0,0,0,0.18); }
    .hot.is-active{ stroke: rgba(0,0,0,0.25); }

    .hot-red:hover, .hot-red.is-active{
      fill: rgba(255, 0, 0, 0.14);
      stroke: rgba(255, 0, 0, 0.55);
    }
    .hot-blue:hover, .hot-blue.is-active{
      fill: rgba(0, 90, 255, 0.14);
      stroke: rgba(0, 90, 255, 0.55);
    }
    .hot-cyan:hover, .hot-cyan.is-active{
      fill: rgba(0, 200, 220, 0.14);
      stroke: rgba(0, 200, 220, 0.55);
    }
    .hot-black:hover, .hot-black.is-active{
      fill: rgba(0, 0, 0, 0.10);
      stroke: rgba(0, 0, 0, 0.55);
    }
    .hot-audio:hover, .hot-audio.is-active{
      fill: rgba(120, 120, 120, 0.18);
      stroke: rgba(120, 120, 120, 0.70);
    }
    .hot-uc:hover, .hot-uc.is-active{
      fill: rgba(60, 60, 60, 0.22);
      stroke: rgba(60, 60, 60, 0.80);
    }
    .hot-magenta:hover, .hot-magenta.is-active{
      fill: rgba(255, 0, 255, 0.12);
      stroke: rgba(255, 0, 255, 0.55);
    }

    .map-panels{
      max-width: 900px;
      margin: 0 auto;
    }
    .map-panels h3{
      margin: 12px 0 6px;
    }

    /* ===== panzoom ===== */
    .panzoom{
      position: relative;
      width: 100%;
      max-width: 900px;
      margin: 0 auto;
      overflow: visible;
      cursor: grab;
      user-select: none;
      touch-action: none;
    }
    .panzoom:active{ cursor: grabbing; }
    .panzoom-img{
      display: block;
      width: 100%;
      height: auto;
      border-radius: 10px;
      transform-origin: 0 0;
      will-change: transform;
    }
  </style>
</head>

<body>
  <div class="container">
    <a class="back" href="./projects.html">‚Üê Back to Projects</a>
    <h1>FM Transceiver</h1>

    <p>
      This project was made for the Electronics Engineering program at Okanagan College in 2022. The idea was to integrate digital control architecture with RF components to create a low power 2-way FM radio (pair of walkie talkies); Below is a technical description of the project.
    </p>

    <hr>

    <!-- Overview -->
    <a class="section-link" id="softwareLink" href="#">Overview</a>

    <div id="softwarePanel" class="drop-panel" hidden aria-hidden="true">
      <div class="drop-inner">
        <div class="schematics-list">

          <a class="section-link" href="#" data-sw="software-description">Executive summary</a>
          <div class="drop-panel" id="sw-software-description" hidden aria-hidden="true">
            <div class="drop-inner">
              <p>...</p>
            </div>
          </div>

          <a class="section-link" href="#" data-sw="software-flowchart">Scope</a>
          <div class="drop-panel" id="sw-software-flowchart" hidden aria-hidden="true">
            <div class="drop-inner">
              <p>...</p>
            </div>
          </div>

          <a class="section-link" href="#" data-sw="software-code">Control</a>
          <div class="drop-panel" id="sw-software-code" hidden aria-hidden="true">
            <div class="drop-inner">

              <div class="panzoom" data-zoom="1.05">
                <img class="panzoom-img" src="assets/photos/fm/soft-flow.png" alt="Software block diagram" draggable="false" />
              </div>

              <p>
                The system begins by initializing all modules and I/O ports before displaying key operating metrics on the graphical LCD. During normal operation, the transceiver remains in receive mode while continuously monitoring user inputs. The mode selection determines the function of the up and down buttons, allowing the user to change the active channel, adjust audio volume, or modify screen brightness. If the transmit button is pressed, the system temporarily switches to transmit mode and returns to receive mode once the button is released. This control loop repeats continuously to enable responsive, real-time interaction with the device.
              </p>

            </div>
          </div>

          <a class="section-link" href="#" data-sw="block-diagram">Block Diagram</a>
          <div class="drop-panel" id="sw-block-diagram" hidden aria-hidden="true">
            <div class="drop-inner">

              <section class="subsystem-map">
                <div class="map-wrap" aria-label="Subsystem diagram">
                  <img src="assets/photos/fm/block-diagram.png" alt="FM Transceiver subsystem block diagram" />

                  <svg class="map-overlay" viewBox="0 0 872 804" aria-hidden="true">
                    <rect class="hot hot-red" data-target="battery-management" x="77" y="190" width="736" height="137" rx="18" />
                    <rect class="hot hot-blue" data-target="interrupts"        x="260" y="17"  width="325" height="307" rx="18" />
                    <rect class="hot hot-cyan" data-target="decoupling"         x="78"  y="330" width="195" height="142" rx="18" />
                    <rect class="hot hot-black" data-target="glcd"             x="85"  y="490" width="465" height="120" rx="18" />
                    <rect class="hot hot-audio" data-target="audio-amplifier"  x="325" y="355" width="225" height="120" rx="18" />
                    <rect class="hot hot-uc" data-target="microcontroller"     x="340" y="632" width="210" height="120" rx="18" />
                    <rect class="hot hot-magenta" data-target="transceiver"    x="555" y="345" width="265" height="425" rx="18" />
                  </svg>
                </div>

                <div class="map-panels">
                  <div id="panel-battery-management" class="drop-panel" hidden aria-hidden="true"><div class="drop-inner"><h3>Battery management</h3><p>...</p></div></div>
                  <div id="panel-interrupts" class="drop-panel" hidden aria-hidden="true"><div class="drop-inner"><h3>System inputs</h3><p>...</p></div></div>
                  <div id="panel-decoupling" class="drop-panel" hidden aria-hidden="true"><div class="drop-inner"><h3>MCU support</h3><p>...</p></div></div>
                  <div id="panel-glcd" class="drop-panel" hidden aria-hidden="true"><div class="drop-inner"><h3>Outputs</h3><p>...</p></div></div>
                  <div id="panel-audio-amplifier" class="drop-panel" hidden aria-hidden="true"><div class="drop-inner"><h3>Audio amplifier</h3><p>...</p></div></div>
                  <div id="panel-microcontroller" class="drop-panel" hidden aria-hidden="true"><div class="drop-inner"><h3>Microcontroller</h3><p>...</p></div></div>
                  <div id="panel-transceiver" class="drop-panel" hidden aria-hidden="true"><div class="drop-inner"><h3>RF backend</h3><p>...</p></div></div>
                </div>
              </section>

            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- Schematics -->
    <a class="section-link" id="schematicsLink" href="#">Schematics</a>

    <div id="schematicsPanel" class="drop-panel" hidden aria-hidden="true">
      <div class="drop-inner">
        <div class="schematics-list">
          <!-- your 12 schematic dropdowns unchanged -->
          <!-- ... keep your existing dd-* blocks here exactly as you had them ... -->
        </div>
      </div>
    </div>

    <script>
      // ===== helpers (ONLY ONCE) =====
      function shiftToViewportCenter(el){
        const r = el.getBoundingClientRect();
        const elCenter = r.left + r.width / 2;
        const viewportCenter = window.innerWidth / 2;
        return viewportCenter - elCenter;
      }

      function waitForTransition(el, prop){
        return new Promise((resolve) => {
          const onEnd = (e) => {
            if (e.propertyName !== prop) return;
            el.removeEventListener("transitionend", onEnd);
            resolve();
          };
          el.addEventListener("transitionend", onEnd);
        });
      }

      async function openPanel(panel){
        panel.hidden = false;
        panel.setAttribute("aria-hidden", "false");

        panel.style.maxHeight = "0px";
        panel.getBoundingClientRect();

        panel.classList.add("is-open");
        panel.style.maxHeight = panel.scrollHeight + "px";

        await waitForTransition(panel, "max-height");
        panel.style.maxHeight = "none";
      }

      async function closePanel(panel){
        panel.style.maxHeight = panel.scrollHeight + "px";
        panel.getBoundingClientRect();

        panel.classList.remove("is-open");
        panel.style.maxHeight = "0px";

        await waitForTransition(panel, "max-height");

        panel.hidden = true;
        panel.setAttribute("aria-hidden", "true");
      }

      // ===== Overview (software) =====
      const softwareLink  = document.getElementById("softwareLink");
      const softwarePanel = document.getElementById("softwarePanel");
      let softwareOpen = false;
      let softwareSliding = false;

      async function softwareSlideToCenter(){
        if (softwareSliding) return;
        softwareSliding = true;

        softwareLink.style.transform = "translateX(0px)";
        softwareLink.getBoundingClientRect();

        requestAnimationFrame(() => {
          const shift = shiftToViewportCenter(softwareLink);
          softwareLink.style.transform = `translateX(${shift}px)`;
        });

        await waitForTransition(softwareLink, "transform");
        softwareSliding = false;
      }

      async function softwareSlideBackLeft(){
        if (softwareSliding) return;
        softwareSliding = true;

        softwareLink.style.transform = "translateX(0px)";
        await waitForTransition(softwareLink, "transform");

        softwareSliding = false;
      }

      softwareLink.addEventListener("click", async (e) => {
        e.preventDefault();
        if (softwareSliding) return;

        softwareOpen = !softwareOpen;

        if (softwareOpen) {
          softwareLink.classList.add("is-selected");
          await softwareSlideToCenter();
          await openPanel(softwarePanel);
        } else {
          // close nested panels
          softwarePanel.querySelectorAll(".drop-panel").forEach((p) => {
            p.classList.remove("is-open");
            p.style.maxHeight = "0px";
            p.hidden = true;
            p.setAttribute("aria-hidden", "true");
          });
          softwarePanel.querySelectorAll(".section-link").forEach((a) => a.classList.remove("is-selected"));

          await closePanel(softwarePanel);
          softwareLink.classList.remove("is-selected");
          await softwareSlideBackLeft();
        }
      });

      document.querySelectorAll("[data-sw]").forEach((btn) => {
        const key = btn.getAttribute("data-sw");
        const panel = document.getElementById(`sw-${key}`);
        if (!panel) return;

        btn.addEventListener("click", async (e) => {
          e.preventDefault();
          if (softwarePanel.hidden) return;

          if (panel.hidden) {
            btn.classList.add("is-selected");
            await openPanel(panel);
          } else {
            await closePanel(panel);
            btn.classList.remove("is-selected");
          }
        });
      });

      // ===== Schematics =====
      const schematicsLink = document.getElementById("schematicsLink");
      const schematicsPanel = document.getElementById("schematicsPanel");
      let schematicsOpen = false;
      let schematicsSliding = false;

      async function schematicsSlideToCenter(){
        if (schematicsSliding) return;
        schematicsSliding = true;

        schematicsLink.style.transform = "translateX(0px)";
        schematicsLink.getBoundingClientRect();

        requestAnimationFrame(() => {
          const shift = shiftToViewportCenter(schematicsLink);
          schematicsLink.style.transform = `translateX(${shift}px)`;
        });

        await waitForTransition(schematicsLink, "transform");
        schematicsSliding = false;
      }

      async function schematicsSlideBackLeft(){
        if (schematicsSliding) return;
        schematicsSliding = true;

        schematicsLink.style.transform = "translateX(0px)";
        await waitForTransition(schematicsLink, "transform");

        schematicsSliding = false;
      }

      schematicsLink.addEventListener("click", async (e) => {
        e.preventDefault();
        if (schematicsSliding) return;

        schematicsOpen = !schematicsOpen;

        if (schematicsOpen) {
          schematicsLink.classList.add("is-selected");
          await schematicsSlideToCenter();
          await openPanel(schematicsPanel);
        } else {
          document.querySelectorAll(".schematics-list .drop-panel").forEach((p) => {
            p.classList.remove("is-open");
            p.style.maxHeight = "0px";
            p.hidden = true;
            p.setAttribute("aria-hidden", "true");
          });
          document.querySelectorAll(".schematics-list .section-link").forEach((a) => a.classList.remove("is-selected"));

          await closePanel(schematicsPanel);
          schematicsLink.classList.remove("is-selected");
          await schematicsSlideBackLeft();
        }
      });

      document.querySelectorAll(".schematics-list [data-dd]").forEach((btn) => {
        const key = btn.getAttribute("data-dd");
        const panel = document.getElementById(`dd-${key}`);
        if (!panel) return;

        btn.addEventListener("click", async (e) => {
          e.preventDefault();
          if (schematicsPanel.hidden) return;

          if (panel.hidden) {
            btn.classList.add("is-selected");
            await openPanel(panel);
          } else {
            await closePanel(panel);
            btn.classList.remove("is-selected");
          }
        });
      });

      // ===== Subsystem map click behavior =====
      const regions = Array.from(document.querySelectorAll(".map-overlay .hot"));
      const panels = new Map(
        Array.from(document.querySelectorAll(".map-panels .drop-panel"))
          .map(p => [p.id.replace("panel-",""), p])
      );

      let active = null;

      regions.forEach(r => {
        r.addEventListener("click", async () => {
          const key = r.dataset.target;
          const panel = panels.get(key);
          if (!panel) return;

          if (active === key){
            r.classList.remove("is-active");
            await closePanel(panel);
            active = null;
            return;
          }

          if (active){
            const prevRegion = regions.find(x => x.dataset.target === active);
            const prevPanel = panels.get(active);
            if (prevRegion) prevRegion.classList.remove("is-active");
            if (prevPanel && !prevPanel.hidden) await closePanel(prevPanel);
          }

          regions.forEach(x => x.classList.toggle("is-active", x.dataset.target === key));
          await openPanel(panel);
          active = key;

          panel.scrollIntoView({ behavior: "smooth", block: "start" });
        });
      });

      // ===== Pan/zoom =====
      (function setupPanZoom(){
        document.querySelectorAll(".panzoom").forEach((wrap) => {
          const img = wrap.querySelector(".panzoom-img");
          if (!img) return;

          let scale = Number(wrap.dataset.zoom || 1.05);
          const MIN = 1.0;
          const MAX = 1.35;
          const WHEEL_STEP = 0.08;

          let tx = 0, ty = 0;
          let dragging = false;
          let startX = 0, startY = 0;
          let startTX = 0, startTY = 0;

          const clamp = (v, min, max) => Math.max(min, Math.min(max, v));

          function apply(){
            img.style.transform = `translate(${tx}px, ${ty}px) scale(${scale})`;
          }

          function setScale(newScale, anchorX, anchorY){
            const prev = scale;
            scale = clamp(newScale, MIN, MAX);

            const ax = anchorX, ay = anchorY;
            tx = ax - (ax - tx) * (scale / prev);
            ty = ay - (ay - ty) * (scale / prev);

            apply();
          }

          if (img.complete) apply();
          else img.addEventListener("load", apply, { once: true });

          wrap.addEventListener("pointerdown", (e) => {
            dragging = true;
            wrap.setPointerCapture(e.pointerId);
            startX = e.clientX;
            startY = e.clientY;
            startTX = tx;
            startTY = ty;
          });

          wrap.addEventListener("pointermove", (e) => {
            if (!dragging) return;
            tx = startTX + (e.clientX - startX);
            ty = startTY + (e.clientY - startY);
            apply();
          });

          function endDrag(e){
            dragging = false;
            try { wrap.releasePointerCapture(e.pointerId); } catch {}
          }
          wrap.addEventListener("pointerup", endDrag);
          wrap.addEventListener("pointercancel", endDrag);

          wrap.addEventListener("wheel", (e) => {
            e.preventDefault();
            const rect = wrap.getBoundingClientRect();
            const ax = e.clientX - rect.left;
            const ay = e.clientY - rect.top;

            const dir = e.deltaY > 0 ? -1 : 1;
            setScale(scale + dir * WHEEL_STEP, ax, ay);
          }, { passive: false });
        });
      })();

      // keep centered on resize for both headers
      window.addEventListener("resize", () => {
        if (softwareOpen){
          softwareLink.style.transform = `translateX(${shiftToViewportCenter(softwareLink)}px)`;
          if (!softwarePanel.hidden && softwarePanel.style.maxHeight !== "none") softwarePanel.style.maxHeight = softwarePanel.scrollHeight + "px";
        }
        if (schematicsOpen){
          schematicsLink.style.transform = `translateX(${shiftToViewportCenter(schematicsLink)}px)`;
          if (!schematicsPanel.hidden && schematicsPanel.style.maxHeight !== "none") schematicsPanel.style.maxHeight = schematicsPanel.scrollHeight + "px";
        }
      });
    </script>
  </div>
</body>
</html>
